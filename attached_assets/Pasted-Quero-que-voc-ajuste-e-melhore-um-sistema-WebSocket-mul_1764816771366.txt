Quero que vocÃª ajuste e melhore um sistema WebSocket multiplayer, utilizando o que jÃ¡ estÃ¡ implementado anteriormente.
Existem dois grandes blocos de requisitos, e vocÃª deve garantir que nenhum ajuste apague o que jÃ¡ estÃ¡ funcionando.
Seu trabalho Ã© completar o que falta e corrigir o novo erro, sem retroceder no sistema.

ğŸ§© Parte 1 â€” O que JÃ estÃ¡ implementado parcialmente (manter e melhorar)
Objetivo principal:

Nenhum jogador deve ser expulso por inatividade.
Jogadores nÃ£o podem virar ghost.
ConexÃ£o deve se manter ativa e recuperar automaticamente.

Mantenha e finalize corretamente os itens abaixo:
1. Heartbeat (ping/pong) â€” deve permanecer

Servidor envia ping periodicamente para verificar vida do socket

Cliente responde pong

Se nÃ£o houver resposta â†’ nÃ£o remover player

Apenas marcar como connected: false e aguardar reconexÃ£o

2. ReconexÃ£o automÃ¡tica

Se socket.onclose ou perda de conexÃ£o â†’ cliente deve reconectar sozinho

ReconexÃ£o deve utilizar a mesma sessionID

ApÃ³s reconectar â†’ enviar sync_request

3. Sync quando a janela volta ao foco

Se visibilitychange === visible â†’ enviar sync_request

Servidor retorna estado completo do lobby e forÃ§a atualizaÃ§Ã£o no cliente

Isso corrige ghosts quando aba volta

4. Anti-Ghost (sem expulsÃ£o)

Jogadores sÃ³ podem sair se clicarem explicitamente em "sair"

Quedas, tela desligada ou aba inativa nÃ£o removem do servidor

ReconexÃ£o restaura o mesmo jogador com mesmo ID

5. Iniciar partida apenas com players sincronizados
const activePlayers = players.filter(p => p.connected === true);
// NÃƒO deletar desconectados


âœ” Isso jÃ¡ estÃ¡ parcialmente funcional e nÃ£o deve ser descartado.

ğŸ§© Parte 2 â€” NOVO PROBLEMA CRÃTICO (corrigir sem quebrar o restante)

Apesar de tudo acima estar quase pronto, ainda existe um bug grave:

â— Quando o jogador fecha o navegador (hard-exit) o servidor NÃƒO detecta a saÃ­da

Ele permanece no lobby como se estivesse ativo, ficando como ghost permanente.

O que deve ser feito:

Detectar fechamento real de navegador â†’ onbeforeunload, visibilitychange, pagehide, unload

Enviar disconnect_notice antes do WebSocket morrer, quando possÃ­vel

Caso o cliente caia abruptamente sem aviso, atualizar status automaticamente:

ğŸ“Œ Regras obrigatÃ³rias:

SituaÃ§Ã£o	O que deve acontecer
Jogador fecha aba / navegador	Marcar connected = false, nÃ£o remover
Jogador volta mais tarde	Reconectar com MESMO ID e reativar
Jogador nÃ£o volta nunca	Fica na sala (host pode expulsar manualmente se quiser)
Timeout NÃƒO pode limpar usuÃ¡rio	PROIBIDO expulsar

âš  Repetindo â€” o servidor NUNCA deve apagar o jogador automaticamente.

O que vocÃª deve entregar no final

CÃ³digo servidor WebSocket atualizado com:

heartbeat

sync_on_focus

reconexÃ£o salva por sessionID

status persistente mesmo desconectado

detecÃ§Ã£o de hard-exit

CÃ³digo do cliente que:

reconecta sozinho sempre

envia sync ao voltar foco

avisa ao servidor quando o navegador fecha (se possÃ­vel)

mantÃ©m sessionID contÃ­nuo

Garantir que o que jÃ¡ estava funcionando NÃƒO seja removido.

Corrigir APENAS o que falta â€” principalmente o ghost ao fechar navegador.

ğŸ“¢ Se qualquer soluÃ§Ã£o envolver timeout para expulsÃ£o â†’ estÃ¡ ERRADO.